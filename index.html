<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gyro Cumulative Test</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  p { font-size: 1.5em; }
  button { padding: 10px 20px; font-size: 1em; }
</style>
</head>
<body>
<h2>📡 Gyro Cumulative Test ±1800°</h2>
<button id="startBtn">Start Gyro</button>
<p>Cumulative Rotation (°): <span id="cumulative">0</span></p>
<p>vJoy Value (0–32767): <span id="vjoy">0</span></p>
<p id="status">Waiting...</p>

<script>
const cumulativeEl = document.getElementById("cumulative");
const vjoyEl = document.getElementById("vjoy");
const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");

let lastGamma = null;
let cumulativeGamma = 0;

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";
    statusEl.innerText = "Gyro started";

    if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response === 'granted') {
                    window.addEventListener("deviceorientation", handleOrientation);
                    statusEl.innerText = "iOS permission granted";
                } else {
                    alert("Permission denied for DeviceOrientation");
                }
            })
            .catch(console.error);
    } else {
        window.addEventListener("deviceorientation", handleOrientation);
    }
});

function handleOrientation(event) {
    const gamma = event.gamma || 0;

    if(lastGamma !== null){
        let delta = gamma - lastGamma;

        // แก้ปัญหาข้าม -180°/+180°
        if(delta > 180) delta -= 360;
        if(delta < -180) delta += 360;

        cumulativeGamma += delta;

        // Clamp ±1800°
        cumulativeGamma = Math.max(-1800, Math.min(1800, cumulativeGamma));

        cumulativeEl.innerText = cumulativeGamma.toFixed(1);

        // Map ±1800° → 0–32767 vJoy
        let vjoyValue = Math.round((cumulativeGamma + 1800)/3600 * 32767);
        vjoyEl.innerText = vjoyValue;
    }

    lastGamma = gamma;
}
</script>
</body>
</html>
