<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gyro to vJoy</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
  #value { font-size: 2em; color: #007ACC; }
  #vjoy { font-size: 2em; color: #FF6600; }
  button { padding: 10px 20px; font-size: 1em; }
</style>
</head>
<body>
<h2>ðŸ“¡ Sending Gyro Data to vJoy</h2>
<p id="status">Waiting for connection...</p>
<button id="startBtn">Start Gyro</button>
<p>Cumulative Rotation (Â°): <span id="value">0</span></p>
<p>vJoy Value: <span id="vjoy">0</span></p>

<script>
const server = "wss://192.168.1.100:8080"; // à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ IP PC
let ws = new WebSocket(server);

let lastGamma = null;
let cumulativeGamma = 0;

const valueDisplay = document.getElementById("value");
const vjoyDisplay = document.getElementById("vjoy");
const startBtn = document.getElementById("startBtn");

ws.onopen = () => console.log("WebSocket connected");
ws.onerror = (err) => console.log("WebSocket error", err);

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

startBtn.addEventListener("click", () => {
    startBtn.style.display = "none";

    if (isIOS && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
        .then(response => {
            if (response === 'granted') {
                window.addEventListener("deviceorientation", handleOrientation);
                document.getElementById("status").innerText = "iOS permission granted";
                console.log("iOS permission granted");
            } else {
                alert("Permission denied for DeviceOrientation");
            }
        })
        .catch(console.error);
    } else {
        // Android / Desktop
        window.addEventListener("deviceorientation", handleOrientation);
        document.getElementById("status").innerText = "Gyro started (Android/Desktop)";
        console.log("Gyro started (Android/Desktop)");
    }
});

function handleOrientation(event) {
    const gamma = event.gamma || 0;

    if (lastGamma !== null) {
        let delta = gamma - lastGamma;
        if (delta > 180) delta -= 360;
        if (delta < -180) delta += 360;

        cumulativeGamma += delta;
        if (cumulativeGamma > 1800) cumulativeGamma = 1800;
        if (cumulativeGamma < -1800) cumulativeGamma = -1800;

        // à¸­à¸±à¸›à¹€à¸”à¸•à¸šà¸™à¸«à¸™à¹‰à¸²à¹€à¸§à¹‡à¸š
        valueDisplay.innerText = cumulativeGamma.toFixed(1);

        // Map Â±1800Â° â†’ 0â€“32767
        let vjoyValue = Math.round((cumulativeGamma + 1800)/3600 * 32767);
        vjoyValue = Math.max(0, Math.min(32767, vjoyValue));
        vjoyDisplay.innerText = vjoyValue;

        if (ws.readyState === WebSocket.OPEN) {
            ws.send(cumulativeGamma.toString());
        }
    }

    lastGamma = gamma;
}
</script>
</body>
</html>
