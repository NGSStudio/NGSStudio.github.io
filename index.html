<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gyroscope API Example</title>
</head>
<body>
<h2>Gyroscope API</h2>
<input type="text" id="serverUrl" placeholder="http://192.168.1.10:3000/data">
<br>
<button onclick="startTracking()">เริ่มส่งค่า</button>
<div id="output">Waiting...</div>

<script>
let serverUrl = "";
let trackingStarted = false;

function sendToServer(zValue) {
  if (!serverUrl) return;
  fetch(serverUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rotation: zValue })
  }).catch(err => console.error('POST error:', err));
}

function startTracking() {
  serverUrl = document.getElementById('serverUrl').value.trim();
  if (!serverUrl) {
    alert('กรุณากรอก URL ของ server');
    return;
  }
  trackingStarted = true;
  alert(`เริ่มส่งค่าแกน Z ไปที่ ${serverUrl}`);
}

if ('Gyroscope' in window) {
  try {
    let gyro = new Gyroscope({ frequency: 60 });

    let angle = { x:0, y:0, z:0 };
    let last = performance.now();

    // smoothing state
    let smoothZ = 0;

    // คุมความเร็วในการเปลี่ยนค่า (deg ต่อหนึ่ง sample)
    const maxStep = 1.5; // ถ้ากระโดดมากกว่านี้จะค่อยๆ ไล่ตาม

    let lastUIUpdate = 0;

    gyro.addEventListener('reading', () => {
      let now = performance.now();
      let dt = (now - last) / 1000;
      last = now;

      // integrate
      angle.x += gyro.x * dt;
      angle.y += gyro.y * dt;
      angle.z += gyro.z * dt;

      // คำนวณองศา
      let zDeg = angle.z * 180 / Math.PI;

      // คุมไม่ให้กระโดดแรง (delta clamp)
      let delta = zDeg - smoothZ;
      if (Math.abs(delta) > maxStep) {
        smoothZ += Math.sign(delta) * maxStep;
      } else {
        smoothZ = zDeg;
      }

      // ส่งค่าไปเซิร์ฟเวอร์
      if (trackingStarted) {
        sendToServer(smoothZ.toFixed(1));
      }

      // อัปเดต UI ทุก 100ms
      if (now - lastUIUpdate > 100) {
        document.getElementById('output').innerHTML = `
          Angular velocity:<br>
          x: ${gyro.x.toFixed(3)} rad/s<br>
          y: ${gyro.y.toFixed(3)} rad/s<br>
          z: ${gyro.z.toFixed(3)} rad/s<br><br>

          Integrated angle:<br>
          x: ${(angle.x*180/Math.PI).toFixed(1)}°<br>
          y: ${(angle.y*180/Math.PI).toFixed(1)}°<br>
          z: ${smoothZ.toFixed(1)}°
        `;
        lastUIUpdate = now;
      }
    });

    gyro.start();
  } catch (err) {
    document.getElementById('output').textContent = "Gyroscope error: " + err;
  }
} else {
  document.getElementById('output').textContent = "Gyroscope API not supported in this browser.";
}
</script>
</body>
</html>
