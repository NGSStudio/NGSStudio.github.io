<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gyroscope API Example</title>
</head>
<body>
<h2>Gyroscope API</h2>
<input type="text" id="serverUrl" placeholder="http://192.168.1.10:3000/data">
  <br>
  <button onclick="startTracking()">เริ่มส่งค่า</button>
<div id="output">Waiting...</div>

<script>
let serverUrl = "";
let trackingStarted = false;
let latestZ = 0; // เก็บค่า z ล่าสุด

function sendToServer(zValue) {
  if (!serverUrl) return;
  fetch(serverUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ rotation: zValue })
  }).catch(err => console.error('POST error:', err));
}

function startTracking() {
  serverUrl = document.getElementById('serverUrl').value.trim();
  if (!serverUrl) {
    alert('กรุณากรอก URL ของ server');
    return;
  }
  trackingStarted = true;
  alert(`เริ่มส่งค่าแกน Z ไปที่ ${serverUrl}`);
}

// Gyroscope
if ('Gyroscope' in window) {
  try {
    let gyro = new Gyroscope({ frequency: 250 });

    let angle = { x:0, y:0, z:0 };
    let last = performance.now();

    gyro.addEventListener('reading', () => {
      let now = performance.now();
      let dt = (now - last) / 1000;
      last = now;

      angle.x += gyro.x * dt;
      angle.y += gyro.y * dt;
      angle.z += gyro.z * dt;

      latestZ = (angle.z*180/Math.PI).toFixed(1); // เก็บค่า z ล่าสุด
    });

    gyro.start();

    // ส่งค่า 10 ครั้งต่อวิ (ทุก 100ms)
    setInterval(() => {
      if (trackingStarted) {
        sendToServer(latestZ);
        document.getElementById('output').textContent = `ส่งค่า Z: ${latestZ}°`;
      }
    }, 100);

  } catch (err) {
    document.getElementById('output').textContent = "Gyroscope error: " + err;
  }
} else {
  document.getElementById('output').textContent = "Gyroscope API not supported in this browser.";
}
</script>
</body>
</html>
